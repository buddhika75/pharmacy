<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="./resources/template/template.xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ez="http://java.sun.com/jsf/composite/ezcomp"
                xmlns:bi="http://java.sun.com/jsf/composite/bill">




    <ui:define name="content">

        <h:outputStylesheet library="css" name="printing.css" />

        <h:panelGroup styleClass="opdPanel" >
            <h:form id="form">

                <h:panelGroup rendered="#{!appointmentController.printPreview}" styleClass="alignTop" >
                    <p:panel style="min-height: 600px; position:relative;"  >
                        <f:facet name="header" >
                            <h:panelGrid columns="17"  >
                                <h:outputLabel value="Appointment" />
                                <h:outputLabel value="&nbsp;&nbsp;&nbsp;&nbsp;" style="min-width: 50px;" />
                                <p:selectOneMenu   id="cmbPs" value="#{appointmentController.currentBill.paymentScheme}">                                                                     
                                    <f:selectItems value="#{paymentSchemeController.items}" var="paysch" itemLabel="#{paysch.name}" itemValue="#{paysch}"  />
                                    <p:ajax process="cmbPs wsd wcd" update="pBillDetails  lblCardRef txtCardRef creditBank lblCheqRef txtCheqRef chequeDate bank lblSlipRef txtSlipRef slipBank slipDate" event="change" />
                                </p:selectOneMenu>

                                <h:outputLabel id="lblCardRef" value="Card Ref. No" style="display: #{appointmentController.currentBill.paymentMethod ne 'Card' ? 'none' : 'block'} ; " />                                
                                <p:inputMask mask="9999-9999-9999-9999" id="txtCardRef" autocomplete="off" maxlength="16" value="#{appointmentController.currentBill.creditCardRefNo}" style="display: #{appointmentController.currentBill.paymentMethod ne 'Card' ? 'none' : 'block'} ; " />                                
                                <h:selectOneMenu id="creditBank" value="#{appointmentController.creditBank}" style="display: #{appointmentController.currentBill.paymentMethod ne 'Card' ? 'none' : 'block'} ; ">
                                    <f:selectItem itemLabel="Select Bank"/>
                                    <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}"/>
                                </h:selectOneMenu>

                                <h:outputLabel id="lblCheqRef" value="Cheque No" style="display: #{appointmentController.currentBill.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; " />
                                <p:inputText  id="txtCheqRef" value="#{appointmentController.currentBill.chequeRefNo}" style="display: #{appointmentController.currentBill.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; " />
                                <h:selectOneMenu id="bank" value="#{appointmentController.chequeBank}" style="display: #{appointmentController.currentBill.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; ">
                                    <f:selectItem itemLabel="Select Bank"/>
                                    <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}"/>
                                </h:selectOneMenu>
                                <p:calendar id="chequeDate"  value="#{appointmentController.currentBill.chequeDate}" pattern="dd MMMM yyyy" style="display: #{appointmentController.currentBill.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; ">                            
                                </p:calendar>

                                <h:outputLabel id="lblSlipRef" value="Slip Memo" style="display: #{appointmentController.currentBill.paymentMethod ne 'Slip' ? 'none' : 'block'} ; " />
                                <p:inputText  id="txtSlipRef" value="#{appointmentController.currentBill.comments}" style="display: #{appointmentController.currentBill.paymentMethod ne 'Slip' ? 'none' : 'block'} ; " />
                                <h:selectOneMenu id="slipBank" value="#{appointmentController.slipBank}" style="display: #{appointmentController.currentBill.paymentMethod ne 'Slip' ? 'none' : 'block'} ; ">
                                    <f:selectItem itemLabel="Select Bank"/>
                                    <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}"/>
                                </h:selectOneMenu>

                                <p:calendar id="slipDate"  value="#{appointmentController.slipDate}" pattern="dd MMMM yyyy" style="display: #{appointmentController.currentBill.paymentMethod ne 'Slip' ? 'none' : 'block'} ; ">                            
                                </p:calendar>

                                <p:commandButton  value="Settle" action="#{appointmentController.settleBill}" ajax="false"  style="width: 150px; padding: 1px;border: 1px solid ; margin: auto;">
                                </p:commandButton>
                                <p:commandButton value="New Bill" ajax="false" action="#{appointmentController.prepareNewBill()}" >
                                </p:commandButton>
                                <p:watermark id="wcd" value="Cheque Date" for="chequeDate"/>
                                <p:watermark id="wsd" value="Slip Date" for="slipDate"/>
                            </h:panelGrid>

                        </f:facet>

                        <h:panelGrid columns="2" >

                            <h:panelGrid columns="1" >

                                <h:panelGroup id="panelPatient" >

                                    <p:tabView id="tvPt" style="min-height: 250px;"  >
                                        <p:ajax event="tabChange"  process="@this" listener="#{appointmentController.onTabChange}" />

                                        <p:tab id="tabNewPt" title="New Patient"  >
                                            <ez:patientDetail controller="#{appointmentController}"/>
                                        </p:tab>
                                        <p:tab id="tabSearchPt" title="Search Patient">

                                            <h:panelGrid columns="1" >
                                                <p:autoComplete widgetVar="aPt" id="acPt" forceSelection="true" 
                                                                value="#{appointmentController.searchedPatient}" 
                                                                completeMethod="#{patientController.completePatient}" 
                                                                var="apt" itemLabel="#{apt.person.name}" 
                                                                itemValue="#{apt}" size="30"  style="width: 400px;">
                                                    <p:ajax event="itemSelect" process="acPt" update="panSearch"/>
                                                </p:autoComplete>   

                                                <h:panelGrid id="panSearch" columns="2" >
                                                    <h:outputLabel  rendered="#{appointmentController.searchedPatient!=null}" value="Name" />
                                                    <h:outputLabel rendered="#{appointmentController.searchedPatient!=null}" value="#{appointmentController.searchedPatient.person.name}" ></h:outputLabel>
                                                    <h:outputLabel  rendered="#{appointmentController.searchedPatient!=null}" value="Sex" />
                                                    <h:outputLabel rendered="#{appointmentController.searchedPatient!=null}" value="#{appointmentController.searchedPatient.person.sex}" ></h:outputLabel>
                                                    <h:outputLabel  rendered="#{appointmentController.searchedPatient!=null}" value="DOB"  />

                                                    <h:outputLabel rendered="#{appointmentController.searchedPatient!=null}" value="#{appointmentController.searchedPatient.person.dob}"   >
                                                        <f:convertDateTime pattern="dd/MM/yy" />
                                                    </h:outputLabel>

                                                    <h:outputLabel  rendered="#{appointmentController.searchedPatient!=null}" value="Adress" />
                                                    <p:inputTextarea rendered="#{appointmentController.searchedPatient!=null}" value="#{appointmentController.searchedPatient.person.address}" />
                                                </h:panelGrid>
                                            </h:panelGrid>

                                        </p:tab>

                                    </p:tabView>

                                </h:panelGroup>


                            </h:panelGrid>


                            <h:panelGrid columns="1" >

                                <p:dialog id="panDoc" header="Add New Doctor" widgetVar="dlg" resizable="false">  
                                    <h:panelGrid columns="2" style="margin-bottom:10px">  
                                        <h:outputText id="lblNameD" value="Name" ></h:outputText>
                                        <h:inputText id="txtNameD"  value="#{doctorController.current.person.name}"  ></h:inputText>
                                        <h:outputText id="lblPhoneD" value="Phone" ></h:outputText>
                                        <h:inputText id="txtPhoneD" value="#{doctorController.current.person.phone}"  ></h:inputText>
                                        <h:outputText id="lblFaxD" value="Fax" ></h:outputText>
                                        <h:inputText id="txtFaxD" value="#{doctorController.current.person.fax}"  ></h:inputText>
                                        <h:outputText id="lblMobileD" value="Mobile" ></h:outputText>
                                        <h:inputText id="txtMobileD" value="#{doctorController.current.person.mobile}"  ></h:inputText>
                                        <h:outputText id="lblAddressD" value="Address" ></h:outputText>
                                        <h:inputText id="txtAddressD" value="#{doctorController.current.person.address}"  ></h:inputText>
                                        <h:outputText value="Speciality" ></h:outputText>                                    
                                        <h:selectOneListbox id="cmbSpecialityD" size="1" value="#{doctorController.current.speciality}" >
                                            <f:selectItem itemLabel="Please select a speciality"/>
                                            <f:selectItems value="#{specialityController.items}" var="cat" itemLabel="#{cat.name}" itemValue="#{cat}" />
                                        </h:selectOneListbox>
                                        <h:outputText id="lblRegD" value="Registration" ></h:outputText>
                                        <h:inputText id="txtRegD" value="#{doctorController.current.registration}"  ></h:inputText>                 
                                        <h:outputText id="lblQuaD" value="Qualification" ></h:outputText>
                                        <h:inputText id="txtQuaD" value="#{doctorController.current.qualification}"  ></h:inputText>   

                                        <p:commandButton id="btnDocSave" value="Add New" process="btnDocSave panDoc" update="panDoc :#{p:component('cmbDoc')}"  actionListener="#{doctorController.saveSelected()}" styleClass="buttons" oncomplete="dlg.hide();">
                                        </p:commandButton>

                                    </h:panelGrid>  

                                </p:dialog>  


                                <h:panelGroup id="panelBillReferrals" >
                                    <p:tabView >
                                        <p:tab title="Refering Doctor">
                                            <p:autoComplete forceSelection="true" id="cmbDoc" value="#{appointmentController.currentBill.referredBy}" completeMethod="#{doctorController.completeDoctor}" var="ix" itemLabel="#{ix.person.name}" itemValue="#{ix}" size="30"  style="width: 400px;">
                                            </p:autoComplete>
                                            <p:commandButton id="btnAddNewDoc" type="button" value="Add New Doctor" onclick="dlg.show();" actionListener="#{doctorController.prepareAdd}" process="btnAddNewDoc" update="#{p:component('panDoc')}" />  
                                        </p:tab>

                                    </p:tabView>
                                </h:panelGroup>

                                <h:panelGrid columns="2">
                                    <p:outputLabel value="Appointment Date :"/>
                                    <p:calendar  value="#{appointmentController.currentAppointment.appointmentDate}" pattern="dd MMMM yyyy">                            
                                    </p:calendar>
                                </h:panelGrid>

                                <h:panelGroup id="panelBillTotals" >

                                    <p:panel header="Bill Details" id="pBillDetails" style="padding: 5px; margin: 10px;" >
                                        <p:panelGrid columns="2" columnClasses="numberCol, textCol"  >
                                            <h:outputLabel value="Amount" ></h:outputLabel>
                                            <p:inputText value="#{appointmentController.currentBill.total}" >
                                                <f:convertNumber pattern="#,##0.00" />
                                            </p:inputText>
                                        </p:panelGrid>

                                    </p:panel>
                                </h:panelGroup>




                            </h:panelGrid>


                        </h:panelGrid>
                    </p:panel>
                </h:panelGroup>


                <h:panelGroup rendered="#{appointmentController.printPreview}" >
                    <bi:InwardAppointmentBill bill="#{appointmentController.currentBill}"/>
                </h:panelGroup>

            </h:form>
        </h:panelGroup>
    </ui:define>
</ui:composition>
